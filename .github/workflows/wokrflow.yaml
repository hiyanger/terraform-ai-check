name: Terraform CI/CD with AI Summary

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  AWS_REGION: ap-northeast-1

jobs:
  # Pull Requestæ™‚: ãƒã‚§ãƒƒã‚¯ & AIè¦ç´„
  terraform-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3.1.2

      # Terraform ãƒã‚§ãƒƒã‚¯ & Plan
      - name: Terraform Check & Plan
        run: |
          terraform fmt -check -recursive || true
          terraform init
          terraform validate
          terraform plan -no-color > plan.txt
        continue-on-error: true

      # TFLint
      - uses: terraform-linters/setup-tflint@v6.2.1
      - run: tflint --init && tflint --format compact || true

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      - uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true

      # AIè¦ç´„ & PRã‚³ãƒ¡ãƒ³ãƒˆ
      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Plançµæœã‚’èª­ã¿è¾¼ã¿
            const plan = fs.readFileSync('plan.txt', 'utf8');
            const prompt = `ä»¥ä¸‹ã®Terraform planã‚’æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„:\n\n${plan}`;
            
            // Bedrockãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ä½œæˆ
            const body = JSON.stringify({
              anthropic_version: "bedrock-2023-05-31",
              max_tokens: 4096,
              messages: [{role: "user", content: prompt}]
            });
            
            // Bedrockï¼ˆClaudeï¼‰ã§AIè¦ç´„ã‚’ç”Ÿæˆ
            const cmd = `aws bedrock-runtime invoke-model --model-id anthropic.claude-sonnet-4-5-20250929-v1:0 --region ${{ env.AWS_REGION }} --body '${body}' --output json /dev/stdout`;
            const result = JSON.parse(execSync(cmd, {encoding: 'utf8'}));
            const summary = result.content[0].text;
            
            // Planè©³ç´°ï¼ˆ60000æ–‡å­—ã¾ã§ï¼‰
            const planPreview = plan.substring(0, 60000);
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– AIè¦ç´„\n\n${summary}\n\n<details><summary>ğŸ“‹ Planè©³ç´°</summary>\n\n\`\`\`\n${planPreview}\n\`\`\`\n</details>`
            });

  # Mergeå¾Œ: æœ¬ç•ªç’°å¢ƒã¸Apply
  terraform-apply:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3.1.2
      - run: terraform init && terraform apply -auto-approve
