name: Terraform CI/CD with AI Summary

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  AWS_REGION: ap-northeast-1
  BEDROCK_MODEL_ID: jp.anthropic.claude-sonnet-4-5-20250929-v1:0

jobs:
  terraform-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: actions/checkout@v6.0.1
      - uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3.1.2
      - uses: terraform-linters/setup-tflint@v6.2.1

      # Terraformãƒã‚§ãƒƒã‚¯
      - name: Terraform Check & Plan
        run: |
          add_result() { echo "$1" >> check-results.txt; }
          {
            echo "# ãƒã‚§ãƒƒã‚¯çµæœ"
          } > check-results.txt
          
          terraform fmt -check -recursive && add_result "âœ… Format: OK" || add_result "âš ï¸ Format: è¦ä¿®æ­£"
          terraform init
          terraform validate && add_result "âœ… Validate: OK" || add_result "âŒ Validate: ã‚¨ãƒ©ãƒ¼"
          terraform plan -no-color > plan.txt && add_result "âœ… Plan: å®Ÿè¡Œå®Œäº†"
        continue-on-error: true

      # Linter & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
      - name: TFLint & tfsec
        run: |
          add_result() { echo "$1" >> check-results.txt; }
          
          tflint --init
          tflint --format compact && add_result "âœ… TFLint: å•é¡Œãªã—" || add_result "âš ï¸ TFLint: è­¦å‘Šã‚ã‚Š"
          
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --format default --soft-fail . && add_result "âœ… tfsec: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œãªã—" || add_result "âš ï¸ tfsec: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚ã‚Š"
        continue-on-error: true

      # AIè¦ç´„ç”Ÿæˆ
      - name: Generate AI Summary
        run: |
          python3 << 'EOF'
          import json, boto3
          
          with open('plan.txt', 'r', encoding='utf-8') as f:
              plan = f.read()
          
          bedrock = boto3.client('bedrock-runtime', region_name='${{ env.AWS_REGION }}')
          response = bedrock.invoke_model(
              modelId='${{ env.BEDROCK_MODEL_ID }}',
              body=json.dumps({
                  "anthropic_version": "bedrock-2023-05-31",
                  "max_tokens": 4096,
                  "messages": [{"role": "user", "content": f"ä»¥ä¸‹ã®Terraform planã‚’æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„:\n\n{plan}"}]
              }, ensure_ascii=False)
          )
          
          with open('bedrock-response.json', 'w', encoding='utf-8') as f:
              json.dump(json.loads(response['body'].read()), f, ensure_ascii=False)
          EOF

      # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const checkResults = fs.readFileSync('check-results.txt', 'utf8');
            const response = JSON.parse(fs.readFileSync('bedrock-response.json', 'utf8'));
            const summary = response.content[0].text;
            const plan = fs.readFileSync('plan.txt', 'utf8').substring(0, 60000);
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${checkResults}\n\n${summary}\n\n# ğŸ“„ Plan è©³ç´°\n<details>\n<summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</summary>\n\n\`\`\`terraform\n${plan}\n\`\`\`\n\n</details>`
            });

  terraform-apply:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3.1.2
      - run: terraform init && terraform apply -auto-approve
